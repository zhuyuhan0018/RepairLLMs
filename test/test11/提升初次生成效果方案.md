# æå‡åˆæ¬¡ç”Ÿæˆæ•ˆæœçš„æ”¹è¿›æ–¹æ¡ˆ

## ä¸€ã€æ ¸å¿ƒé—®é¢˜æ€»ç»“

æ ¹æ®test11çš„å®éªŒç»“æœåˆ†æï¼Œåˆæ¬¡ç”Ÿæˆå¤±è´¥çš„æ ¹æœ¬åŸå› ï¼š

1. **Fix Pointæè¿°ä¿¡æ¯ä¸è¶³** - åªæœ‰ä½ç½®ä¿¡æ¯ï¼Œç¼ºå°‘åŠ¨ä½œç±»å‹å’Œå…·ä½“å†…å®¹
2. **Buggy Codeå®šä½å›°éš¾** - å®Œæ•´ä»£ç åŒ…å«å¤šä¸ªæ–‡ä»¶ï¼Œæ²¡æœ‰æ–‡ä»¶è¾¹ç•Œæ ‡è®°
3. **ç¼ºå°‘æ¼æ´ä¸Šä¸‹æ–‡** - æ²¡æœ‰vulnerability_typeã€root_causeã€fix_goal
4. **æ¨¡å‹ç†è§£åå·®** - å®¹æ˜“è¯¯è§£ä¿®å¤æ€§è´¨ï¼ˆ"æ·»åŠ "vs"ç§»åŠ¨"ï¼‰

---

## äºŒã€æ”¹è¿›æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### ğŸ”´ ä¼˜å…ˆçº§1ï¼šå¢å¼ºFix Pointæè¿°ï¼ˆæœ€å…³é”®ï¼‰

#### é—®é¢˜
å½“å‰Fix Pointæè¿°åªæœ‰ä½ç½®ä¿¡æ¯ï¼š
```
"src/server/ua_session_manager.c:header include (lines 11-16)"
```

#### è§£å†³æ–¹æ¡ˆï¼šåœ¨Repair Order Analysisé˜¶æ®µç”Ÿæˆå¢å¼ºæè¿°

**ä¿®æ”¹ä½ç½®**: `core/initial_chain_builder.py` - `analyze_repair_order` æ–¹æ³•

**æ”¹è¿›å†…å®¹**ï¼š
1. åœ¨repair order analysisçš„promptä¸­ï¼Œè¦æ±‚æ¨¡å‹ä¸ºæ¯ä¸ªfix pointç”Ÿæˆè¯¦ç»†æè¿°
2. æè¿°æ ¼å¼ï¼š
   ```
   [ACTION_TYPE] Action description: [å…·ä½“å†…å®¹] at [ä½ç½®]. 
   Reason: [ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¿®å¤ï¼ŒåŸºäºæ¼æ´æè¿°]
   ```

**å…·ä½“å®ç°**ï¼š

ä¿®æ”¹ `get_repair_order_analysis_prompt`ï¼Œåœ¨è¾“å‡ºæ ¼å¼ä¸­è¦æ±‚åŒ…å«æè¿°ï¼š

```python
# åœ¨ utils/prompts.py ä¸­ä¿®æ”¹è¾“å‡ºæ ¼å¼è¦æ±‚
<fix_points>
1. file_path:function_name (lines line_start-line_end)
   Description: [ACTION_TYPE] Action description: [å…·ä½“å†…å®¹] at [ä½ç½®]. Reason: [åŸå› ]
   
2. file_path:function_name (lines line_start-line_end)
   Description: [ACTION_TYPE] Action description: [å…·ä½“å†…å®¹] at [ä½ç½®]. Reason: [åŸå› ]
...
</fix_points>
```

**ACTION_TYPEæ ‡ç­¾**ï¼š
- `[INCLUDE]` - æ·»åŠ å¤´æ–‡ä»¶åŒ…å«
- `[ADD]` - æ·»åŠ ä»£ç 
- `[REMOVE]` - ç§»é™¤ä»£ç 
- `[MOVE]` - ç§»åŠ¨ä»£ç 
- `[MODIFY]` - ä¿®æ”¹ä»£ç 
- `[REORDER]` - é‡æ’åºä»£ç 

**ç¤ºä¾‹æ”¹è¿›**ï¼š
```
å½“å‰: "src/server/ua_session_manager.c:header include (lines 11-16)"
æ”¹è¿›: "[INCLUDE] Add header include: #include \"ua_subscription.h\" at src/server/ua_session_manager.c (lines 11-16). Reason: Subscription cleanup code will be moved to this file, requiring subscription type definitions."
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¨¡å‹æ˜ç¡®çŸ¥é“éœ€è¦æ‰§è¡Œä»€ä¹ˆåŠ¨ä½œï¼ˆADD/REMOVE/MOVEï¼‰
- æ¨¡å‹çŸ¥é“å…·ä½“è¦æ·»åŠ /ç§»é™¤ä»€ä¹ˆå†…å®¹
- æ¨¡å‹ç†è§£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¿®å¤

---

### ğŸŸ  ä¼˜å…ˆçº§2ï¼šæ”¹è¿›Buggy Codeæå–

#### é—®é¢˜
å½“å‰ä¼ ç»™æ¨¡å‹çš„æ˜¯å®Œæ•´çš„buggyä»£ç ï¼ŒåŒ…å«å¤šä¸ªæ–‡ä»¶ï¼Œæ²¡æœ‰æ–‡ä»¶è¾¹ç•Œæ ‡è®°ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šä¸ºæ¯ä¸ªFix Pointæå–ç²¾ç¡®çš„ä»£ç ç‰‡æ®µ

**ä¿®æ”¹ä½ç½®**: `core/initial_chain_builder.py` - `build_fix_point_chain` æ–¹æ³•

**æ”¹è¿›å†…å®¹**ï¼š
1. ä¸ºæ¯ä¸ªfix pointæå–ç›¸å…³çš„ä»£ç ç‰‡æ®µï¼ˆè€Œä¸æ˜¯å®Œæ•´ä»£ç ï¼‰
2. æ˜ç¡®æ ‡è®°æ–‡ä»¶è¾¹ç•Œå’Œè¡Œå·å¯¹åº”å…³ç³»
3. åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ï¼ˆå‰åå„10-15è¡Œï¼‰

**å…·ä½“å®ç°**ï¼š

```python
def extract_code_for_fix_point(self, buggy_code: str, fix_point: Dict) -> str:
    """
    ä¸ºç‰¹å®šfix pointæå–ç²¾ç¡®çš„ä»£ç ç‰‡æ®µ
    
    Args:
        buggy_code: å®Œæ•´çš„buggyä»£ç 
        fix_point: Fix pointå­—å…¸ï¼ŒåŒ…å«file, line_start, line_end
        
    Returns:
        æå–çš„ä»£ç ç‰‡æ®µï¼ŒåŒ…å«æ–‡ä»¶è¾¹ç•Œæ ‡è®°
    """
    file_path = fix_point.get('file', '')
    line_start = int(fix_point.get('line_start', 0))
    line_end = int(fix_point.get('line_end', 0))
    
    # ä»buggy_codeä¸­æå–è¯¥æ–‡ä»¶çš„ç›¸å…³ä»£ç 
    # å¦‚æœbuggy_codeåŒ…å«å¤šä¸ªæ–‡ä»¶ï¼Œéœ€è¦è§£ææ–‡ä»¶è¾¹ç•Œ
    
    # æå–ç›®æ ‡è¡ŒèŒƒå›´ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡
    context_lines = 15  # å‰åå„15è¡Œä¸Šä¸‹æ–‡
    start_line = max(1, line_start - context_lines)
    end_line = line_end + context_lines
    
    # æ„å»ºä»£ç ç‰‡æ®µ
    code_snippet = f"""// File: {file_path}
// Fix Point Location: lines {line_start}-{line_end}
// Context: lines {start_line}-{end_line} (with {context_lines} lines context)

{extracted_code}

// End of fix point context
"""
    return code_snippet
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¨¡å‹èƒ½å‡†ç¡®å®šä½åˆ°éœ€è¦ä¿®å¤çš„ä»£ç ä½ç½®
- å‡å°‘æ— å…³ä»£ç çš„å¹²æ‰°
- æé«˜ä»£ç å®šä½çš„å‡†ç¡®æ€§

---

### ğŸŸ¡ ä¼˜å…ˆçº§3ï¼šæ·»åŠ æ¼æ´æè¿°ä¸Šä¸‹æ–‡

#### é—®é¢˜
å½“å‰promptä¸­æ²¡æœ‰åŒ…å«æ¼æ´çš„è¯¦ç»†æè¿°ï¼ˆvulnerability_type, root_cause, fix_goalï¼‰ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šåœ¨Initial Fix Promptä¸­æ·»åŠ æ¼æ´ä¸Šä¸‹æ–‡

**ä¿®æ”¹ä½ç½®**: `utils/prompts.py` - `get_initial_fix_prompt` æ–¹æ³•

**æ”¹è¿›å†…å®¹**ï¼š
1. ä»`bug_location`ä¸­æå–vulnerability_typeã€root_causeã€fix_goal
2. åœ¨promptä¸­æ·»åŠ "Vulnerability Context"éƒ¨åˆ†

**å…·ä½“å®ç°**ï¼š

```python
def get_initial_fix_prompt(..., bug_location: str, ...):
    # è§£æbug_locationï¼Œæå–æ¼æ´ä¿¡æ¯
    vulnerability_context = extract_vulnerability_context(bug_location)
    
    # åœ¨promptä¸­æ·»åŠ 
    vulnerability_section = f"""
## Vulnerability Context

**Vulnerability Type**: {vulnerability_context.get('type', 'MEMORY ACCESS')}
**Root Cause**: {vulnerability_context.get('root_cause', 'N/A')}
**Fix Goal**: {vulnerability_context.get('fix_goal', 'N/A')}

**Why this fix is needed**: {vulnerability_context.get('explanation', '')}
"""
    
    # å°†vulnerability_sectionæ·»åŠ åˆ°promptä¸­
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¨¡å‹ç†è§£æ¼æ´çš„æ ¹æœ¬åŸå› 
- æ¨¡å‹ç†è§£ä¿®å¤çš„ç›®æ ‡
- æ¨¡å‹èƒ½æ›´å¥½åœ°æ¨ç†ä¿®å¤æ–¹æ¡ˆ

---

### ğŸŸ¢ ä¼˜å…ˆçº§4ï¼šä¼˜åŒ–Promptç»“æ„

#### é—®é¢˜
- Repair Order Contextå¯èƒ½è¿‡äºè¯¦ç»†ï¼Œåˆ†æ•£æ³¨æ„åŠ›
- Grep Toolè¯´æ˜é‡å¤

#### è§£å†³æ–¹æ¡ˆï¼šç®€åŒ–å¹¶ä¼˜åŒ–Promptç»“æ„

**æ”¹è¿›å†…å®¹**ï¼š

1. **ç®€åŒ–Repair Order Context**
   - å¯¹äºç®€å•çš„fix pointï¼Œåªæ˜¾ç¤ºå½“å‰fix pointå’Œç´§é‚»çš„å‰åfix point
   - å‡å°‘ä¸å¿…è¦çš„ä¿¡æ¯å¹²æ‰°

2. **åˆå¹¶Grep Toolè¯´æ˜**
   - åªä¿ç•™ä¸€å¤„grepå·¥å…·è¯´æ˜
   - ä½¿ç”¨æ›´ç®€æ´çš„æè¿°

3. **é‡æ–°ç»„ç»‡Promptç»“æ„**
   ```
   1. Task Overview (ç®€æ´)
   2. Vulnerability Context (æ–°å¢)
   3. Fix Point Description (å¢å¼º)
   4. Buggy Code (ç²¾ç¡®æå–)
   5. Repair Order Context (ç®€åŒ–)
   6. Grep Tool (åˆå¹¶)
   7. Response Format
   ```

---

## ä¸‰ã€å®æ–½è®¡åˆ’

### é˜¶æ®µ1ï¼šå¢å¼ºFix Pointæè¿°ï¼ˆ1-2å¤©ï¼‰

1. ä¿®æ”¹ `get_repair_order_analysis_prompt`ï¼Œè¦æ±‚æ¨¡å‹ç”Ÿæˆè¯¦ç»†æè¿°
2. ä¿®æ”¹ `_parse_fix_points`ï¼Œè§£æå¹¶ä¿å­˜å¢å¼ºçš„æè¿°
3. ä¿®æ”¹ `get_initial_fix_prompt`ï¼Œä½¿ç”¨å¢å¼ºçš„æè¿°

**éªŒè¯**ï¼šè¿è¡Œtest11ï¼Œæ£€æŸ¥fix pointæè¿°æ˜¯å¦åŒ…å«åŠ¨ä½œç±»å‹å’ŒåŸå› 

### é˜¶æ®µ2ï¼šæ”¹è¿›ä»£ç æå–ï¼ˆ2-3å¤©ï¼‰

1. å®ç° `extract_code_for_fix_point` æ–¹æ³•
2. ä¿®æ”¹ `build_fix_point_chain`ï¼Œä½¿ç”¨ç²¾ç¡®çš„ä»£ç ç‰‡æ®µ
3. å¤„ç†å¤šæ–‡ä»¶ä»£ç çš„è§£æ

**éªŒè¯**ï¼šæ£€æŸ¥æå–çš„ä»£ç ç‰‡æ®µæ˜¯å¦å‡†ç¡®ï¼Œæ˜¯å¦åŒ…å«æ–‡ä»¶è¾¹ç•Œæ ‡è®°

### é˜¶æ®µ3ï¼šæ·»åŠ æ¼æ´ä¸Šä¸‹æ–‡ï¼ˆ1å¤©ï¼‰

1. å®ç° `extract_vulnerability_context` æ–¹æ³•
2. ä¿®æ”¹ `get_initial_fix_prompt`ï¼Œæ·»åŠ æ¼æ´ä¸Šä¸‹æ–‡éƒ¨åˆ†

**éªŒè¯**ï¼šæ£€æŸ¥promptä¸­æ˜¯å¦åŒ…å«æ¼æ´ç±»å‹ã€æ ¹æœ¬åŸå› ã€ä¿®å¤ç›®æ ‡

### é˜¶æ®µ4ï¼šä¼˜åŒ–Promptç»“æ„ï¼ˆ1å¤©ï¼‰

1. ç®€åŒ–Repair Order Context
2. åˆå¹¶Grep Toolè¯´æ˜
3. é‡æ–°ç»„ç»‡Promptç»“æ„

**éªŒè¯**ï¼šæ£€æŸ¥prompté•¿åº¦æ˜¯å¦å‡å°‘ï¼Œç»“æ„æ˜¯å¦æ›´æ¸…æ™°

---

## å››ã€é¢„æœŸæ”¹è¿›æ•ˆæœ

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | é¢„æœŸæ”¹è¿› | æ”¹è¿›å¹…åº¦ |
|------|------|----------|----------|
| åˆæ¬¡ç”ŸæˆæˆåŠŸç‡ | 0/4 (0%) | 2-3/4 (50-75%) | +50-75% |
| å¹³å‡è¿­ä»£æ¬¡æ•° | 3æ¬¡ï¼ˆå…¨éƒ¨å¤±è´¥ï¼‰ | 1-2æ¬¡ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰ | -33-67% |
| Fix Pointæè¿°ä¿¡æ¯é‡ | ~20å­—ç¬¦ | ~150å­—ç¬¦ | +650% |
| Buggy Codeå®šä½å‡†ç¡®åº¦ | ä½ï¼ˆå¤šæ–‡ä»¶æ··æ·†ï¼‰ | é«˜ï¼ˆç²¾ç¡®ç‰‡æ®µï¼‰ | æ˜¾è‘—æå‡ |

### è´¨é‡æ”¹è¿›

1. **Fix Pointç†è§£å‡†ç¡®åº¦**ï¼šä»"ä½ç½®ä¿¡æ¯"æå‡åˆ°"åŠ¨ä½œ+å†…å®¹+åŸå› "
2. **ä»£ç å®šä½å‡†ç¡®åº¦**ï¼šä»"å®Œæ•´ä»£ç ä¸­æœç´¢"æå‡åˆ°"ç²¾ç¡®ä»£ç ç‰‡æ®µ"
3. **ä¿®å¤æ–¹å‘å‡†ç¡®åº¦**ï¼šä»"å®¹æ˜“è¯¯è§£"æå‡åˆ°"æ˜ç¡®æŒ‡å¯¼"

---

## äº”ã€é£é™©ä¸ç¼“è§£

### é£é™©1ï¼šFix Pointæè¿°ç”Ÿæˆè´¨é‡ä¸ç¨³å®š

**ç¼“è§£æªæ–½**ï¼š
- åœ¨repair order analysisé˜¶æ®µä½¿ç”¨æ›´å¼ºçš„çº¦æŸ
- æä¾›æè¿°æ¨¡æ¿å’Œç¤ºä¾‹
- å¦‚æœæè¿°è´¨é‡ä¸è¶³ï¼Œå›é€€åˆ°å½“å‰æ–¹å¼

### é£é™©2ï¼šä»£ç æå–å¯èƒ½é—æ¼é‡è¦ä¸Šä¸‹æ–‡

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨è¾ƒå¤§çš„ä¸Šä¸‹æ–‡çª—å£ï¼ˆ15-20è¡Œï¼‰
- ä¿ç•™å®Œæ•´çš„å‡½æ•°å®šä¹‰
- å¦‚æœæå–å¤±è´¥ï¼Œå›é€€åˆ°å®Œæ•´ä»£ç 

### é£é™©3ï¼šPromptè¿‡é•¿å¯èƒ½å½±å“æ¨¡å‹æ€§èƒ½

**ç¼“è§£æªæ–½**ï¼š
- ä¼˜åŒ–Promptç»“æ„ï¼Œå»é™¤å†—ä½™
- ä½¿ç”¨æ›´ç®€æ´çš„æè¿°
- ç›‘æ§Prompté•¿åº¦ï¼Œæ§åˆ¶åœ¨åˆç†èŒƒå›´

---

## å…­ã€å®æ–½ä¼˜å…ˆçº§å»ºè®®

**ç«‹å³å®æ–½**ï¼ˆæœ¬å‘¨ï¼‰ï¼š
1. âœ… å¢å¼ºFix Pointæè¿°ï¼ˆä¼˜å…ˆçº§1ï¼‰
2. âœ… æ·»åŠ æ¼æ´ä¸Šä¸‹æ–‡ï¼ˆä¼˜å…ˆçº§3ï¼Œå®æ–½ç®€å•ï¼‰

**çŸ­æœŸå®æ–½**ï¼ˆä¸‹å‘¨ï¼‰ï¼š
3. âœ… æ”¹è¿›ä»£ç æå–ï¼ˆä¼˜å…ˆçº§2ï¼‰
4. âœ… ä¼˜åŒ–Promptç»“æ„ï¼ˆä¼˜å…ˆçº§4ï¼‰

**éªŒè¯æ–¹å¼**ï¼š
- è¿è¡Œtest11ï¼ˆæˆ–æ–°çš„test12ï¼‰
- å¯¹æ¯”æ”¹è¿›å‰åçš„æˆåŠŸç‡
- åˆ†ædebugä¿¡æ¯ï¼Œæ£€æŸ¥æ¨¡å‹ç†è§£æ˜¯å¦æ”¹å–„

---

## ä¸ƒã€ä»£ç ä¿®æ”¹ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¢å¼ºFix Pointæè¿°ç”Ÿæˆ

```python
# åœ¨ get_repair_order_analysis_prompt ä¸­æ·»åŠ æè¿°è¦æ±‚
"""
For each fix point, you MUST provide a detailed description in this format:

[ACTION_TYPE] Action description: [å…·ä½“å†…å®¹] at [ä½ç½®]. Reason: [åŸå› ]

ACTION_TYPE must be one of: [INCLUDE], [ADD], [REMOVE], [MOVE], [MODIFY], [REORDER]

Example descriptions:
- [INCLUDE] Add header include: #include "ua_subscription.h" at src/server/ua_session_manager.c (lines 11-16). Reason: Subscription cleanup code will be moved to this file, requiring subscription type definitions.
- [ADD] Add subscription cleanup code to removeSession function before UA_Session_detachFromSecureChannel at src/server/ua_session_manager.c:removeSession (lines 37-42). Reason: Subscriptions must be closed before the SecureChannel is detached to prevent use-after-free.
- [REMOVE] Remove subscription cleanup code from UA_Session_deleteMembersCleanup function at src/server/ua_session.c:UA_Session_deleteMembersCleanup (lines 36-54). Reason: Subscription cleanup is moved to removeSession to ensure proper cleanup order.
"""
```

### ç¤ºä¾‹2ï¼šä»£ç æå–æ–¹æ³•

```python
def extract_code_for_fix_point(self, buggy_code: str, fix_point: Dict) -> str:
    """æå–fix pointç›¸å…³çš„ä»£ç ç‰‡æ®µ"""
    file_path = fix_point.get('file', '')
    line_start = int(fix_point.get('line_start', 0))
    line_end = int(fix_point.get('line_end', 0))
    
    # è§£æå¤šæ–‡ä»¶ä»£ç ï¼Œæå–ç›®æ ‡æ–‡ä»¶
    # è¿™é‡Œéœ€è¦å®ç°æ–‡ä»¶è¾¹ç•Œè§£æé€»è¾‘
    
    # æå–ä»£ç ç‰‡æ®µï¼ˆåŒ…å«ä¸Šä¸‹æ–‡ï¼‰
    context = 15
    # ... å®ç°æå–é€»è¾‘ ...
    
    return f"""// ============================================
// File: {file_path}
// Fix Point: lines {line_start}-{line_end}
// Context: lines {max(1, line_start-context)}-{line_end+context}
// ============================================

{extracted_code}

// ============================================
// End of fix point context
// ============================================
"""
```

---

## å…«ã€æ€»ç»“

**æ ¸å¿ƒæ”¹è¿›ç­–ç•¥**ï¼š
1. **å¢å¼ºä¿¡æ¯**ï¼šFix Pointæè¿°ä»"ä½ç½®"æå‡åˆ°"åŠ¨ä½œ+å†…å®¹+åŸå› "
2. **ç²¾ç¡®å®šä½**ï¼šä»£ç ä»"å®Œæ•´ä»£ç "æå‡åˆ°"ç²¾ç¡®ç‰‡æ®µ"
3. **ä¸°å¯Œä¸Šä¸‹æ–‡**ï¼šæ·»åŠ æ¼æ´ç±»å‹ã€æ ¹æœ¬åŸå› ã€ä¿®å¤ç›®æ ‡
4. **ä¼˜åŒ–ç»“æ„**ï¼šç®€åŒ–å†—ä½™ä¿¡æ¯ï¼Œæé«˜ä¿¡æ¯å¯†åº¦

**é¢„æœŸæ•ˆæœ**ï¼š
- åˆæ¬¡ç”ŸæˆæˆåŠŸç‡ä»0%æå‡åˆ°50-75%
- æ¨¡å‹èƒ½æ›´å‡†ç¡®åœ°ç†è§£ä¿®å¤éœ€æ±‚
- å‡å°‘è¿­ä»£æ¬¡æ•°ï¼Œæé«˜ä¿®å¤æ•ˆç‡

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. å®æ–½ä¼˜å…ˆçº§1å’Œ3ï¼ˆå¢å¼ºæè¿°+æ¼æ´ä¸Šä¸‹æ–‡ï¼‰
2. è¿è¡ŒéªŒè¯å®éªŒ
3. æ ¹æ®ç»“æœè°ƒæ•´å¹¶å®æ–½ä¼˜å…ˆçº§2å’Œ4

